<div class="content-header">
	<div class="container-fluid">
		<div class="row">
			<div class="col">
				<div class="d-flex justify-content-between">
					<div>
						<ol class="breadcrumb float-sm-right">
							<li class="breadcrumb-item active">Dashboard</li>
						</ol>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="text-center" id="container">
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body min-card">
                    <div>
                        <% if current_user.avatar.attached? %>
                            <%= image_tag current_user.avatar, class:'rounded-circle img-height'%>
                        <%else%>
                            <%= image_tag 'placeholder.jpg', class: 'rounded-circle img-height' %>
                        <%end%>
                    </div>
                    <div class="mt-4 text-center">
                        <% if is_manager? || is_employee?%>
                            <div class="mt-1">
                                <label class="label-font-color"><b>Reporting Manager :</b></label>
                                <%= current_user.reporting_manager.present? ? current_user.reporting_manager.first_name : "N/A"%>
                            </div>
                        <%end%>
                        <div class="mt-1">
                            <label class="label-font-color"><b>Name :</b></label>
                            <%= current_user.first_name.present? ? current_user.first_name.titleize  : "N/A"%>
                        </div>
                        <div class="mt-1">
                            <label class="label-font-color"><b>Designation :</b></label>
                            <%= current_user.designation.present? ? current_user.designation.titleize  : "N/A"%>
                        </div>
                        <div class="mt-1">
                            <label class="label-font-color"><b>Email :</b></label>
                            <%= current_user.email.present? ? current_user.email : "N/A"%>
                        </div>
                        <div class="mt-1">
                            <label class="label-font-color"><b>Employee Code :</b></label>
                            <%= current_user.employee_code.present? ? current_user.employee_code : "N/A"%>
                        </div>
                    </div>
                </div>
            </div>
         </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <div id="chart-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div>
    <div class="card">
        <div class="card-body">
        <div class="d-flex justify-content-between">
            <div>
                <h3>Pending Leaves</h3>
            </div>
            <div>
                <%= link_to "View All Leaves", leave_requests_path, class: "btn btn-warning"%>
            </div>
        </div>
        <table class='table'>
                <thead> 
                    <% if is_admin?%>
                        <th>Employee Name</th>
                    <%end%>
                    <th>Leaves</th>
                    <th>Reporting Manager</th>
                    <th>Leave Type</th>
                    <th>Day Type</th>
                    <th>Leave From</th>
                    <th>Leave To</th>
                    <th>Request Time</th>
                    <th>Action</th>
                    <th>Reason</th>
                </thead>
                <tbody>
                    <% if @leave_requests.present?%>
                        <% @leave_requests.each do|leave_request|%>
                            <tr>
                                <% if is_admin?%>
                                    <td>
                                        <%= leave_request.user.first_name.present? ? leave_request.user.first_name.titleize : "N/A"%>
                                    </td>
                                <%end%>
                                <td>
                                    <%= leave_request.user_leave_type&.leave_type&.name.present? ? leave_request.user_leave_type.leave_type.name.titleize : "N/A"%>
                                </td>
                                <td>
                                    <%= leave_request.reporting_manager.first_name.titleize  %>
                                </td>
                                <td>
                                    <%= leave_request.user_leave_type.leave_type.name%>
                                </td>
                                <td>
                                    <%= leave_request.day_type.present? ? leave_request.day_type.titleize : "N/A"%>
                                </td>
                                <td>
                                    <%= leave_request.leave_from.present? ? leave_request.leave_from.strftime("%d %b, %Y") : "N/A"%>
                                </td>
                                <td>
                                    <%= leave_request.leave_to.present? ? leave_request.leave_to.strftime("%d %b, %Y") : "N/A"%>
                                </td>
                                <td>
                                    <%= leave_request.created_at.present? ? leave_request.created_at.in_time_zone("Asia/Kolkata").strftime("%I:%M%p") : "N/A"%>
                                </td>
                                <td>
                                    <div>
                                        <% if is_admin?%>
                                            <% if leave_request.approve.eql?(nil)%>
                                                <%= link_to  leave_approve_leave_request_path(leave_request), method: :post,  'data-toggle': 'tooltip', 'data-placement':'top', title: 'Approve Leave' do%>
													<i class="bi bi-check-circle-fill text-green"></i>
												<%end%>
												<%= link_to leave_reject_leave_request_path(leave_request),method: :post,'data-toggle': 'tooltip', 'data-placement':'top', title: 'Reject Leave' do%>
													<i class="bi bi-x-circle-fill text-danger"></i>
												<%end%>
                                            <%end%>
                                        <% elsif is_manager? || is_employee?%>
                                            <% if leave_request.approve.eql?(nil)%>
                                                <div><span class="text-warning">Pending!</span></div>
                                            <%end%>
                                        <%end%>
                                    </div>
                                </td>
                               <td>
                                     <div id="reason" class="d-none">
									    <%= leave_request.description %>
                                    </div>
                                    <i class="bi bi-info-circle text-primary" onclick="sweetAlertBtn()" data-bs-toggle="tooltip" data-bs-placement="top" title="View Reason"></i>
                                </td>
                            </tr>
                        <%end%>
                    <%else%>
                        <tr>
                            <td colspan="12" class="text-center border-0">
                                <h2 class="mt-3">Record Not Found</h2>
                            </td>
                        </tr>
                    <%end%>
                </tbody>
            </table>
        </div>
    </div>
</div>


<script>
    document.addEventListener("turbo:load", function() {
        Highcharts.chart('chart-container', {
            chart: {
                type: 'pie'
            },
            title: {
                text: "Your Leave Balance",
                align: 'center'
            },
            accessibility: {
                announceNewData: {
                    enabled: true
                },
                point: {
                    valueSuffix: '%'
                }
            },
            tooltip: {
                headerFormat: '<span style="font-size:11px">{point.name}</span><br>',
                pointFormat: '<span style="color:{point.color}"> Balanced</span>: <b>{point.leave_count}/{point.total_count}</b>'
            },
             plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    dataLabels: {
                        enabled: false
                    },
                    showInLegend: true
                }
            },
            series: [
                {
                    name: 'Browsers',
                    colorByPoint: true,
                    data: gon.leaves
                }
            ],
        });
    });

    function sweetAlertBtn() {
        var reason = document.getElementById('reason').innerHTML;
        Swal.fire({
            icon: 'info',
             text: reason
        });
    }
</script>
<style>
    .min-card{
        min-height: 440px;
    }
    .img-height{
        height: 200px;
    }
</style>

